name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            target: linux-amd64
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            target: linux-arm64
            goos: linux
            goarch: arm64
          
          # macOS builds
          - os: macos-latest
            target: darwin-amd64
            goos: darwin
            goarch: amd64
          - os: macos-latest
            target: darwin-arm64
            goos: darwin
            goarch: arm64
          
          # Windows builds
          - os: windows-latest
            target: windows-amd64
            goos: windows
            goarch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build Rust library (Linux amd64)
        if: matrix.target == 'linux-amd64'
        working-directory: rust_ffi
        run: cargo build --release -p fs-operations-core

      - name: Build Rust library (Linux arm64)
        if: matrix.target == 'linux-arm64'
        working-directory: rust_ffi
        run: |
          rustup target add aarch64-unknown-linux-gnu
          cargo build --release --target aarch64-unknown-linux-gnu -p fs-operations-core

      - name: Build Rust library (macOS)
        if: startsWith(matrix.target, 'darwin')
        working-directory: rust_ffi
        run: |
          if [ "${{ matrix.target }}" = "darwin-arm64" ]; then
            rustup target add aarch64-apple-darwin
            cargo build --release --target aarch64-apple-darwin -p fs-operations-core
          else
            cargo build --release -p fs-operations-core
          fi

      - name: Build Rust library (Windows)
        if: matrix.target == 'windows-amd64'
        working-directory: rust_ffi
        run: cargo build --release -p fs-operations-core

      - name: Build Go binary (Linux amd64)
        if: matrix.target == 'linux-amd64'
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 1
          CGO_LDFLAGS: -L../rust_ffi/target/release -lfs_operations_core -ldl -lpthread -lm
        working-directory: file_manager
        run: go build -ldflags="-s -w" -o ../filemanager ./cmd/app

      - name: Build Go binary (Linux arm64)
        if: matrix.target == 'linux-arm64'
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 1
          CC: aarch64-linux-gnu-gcc
          CXX: aarch64-linux-gnu-g++
          CGO_LDFLAGS: -L../rust_ffi/target/aarch64-unknown-linux-gnu/release -lfs_operations_core -ldl -lpthread -lm
        working-directory: file_manager
        run: go build -ldflags="-s -w" -o ../filemanager ./cmd/app

      - name: Build Go binary (macOS amd64)
        if: matrix.target == 'darwin-amd64'
        env:
          GOOS: darwin
          GOARCH: amd64
          CGO_ENABLED: 1
          CGO_LDFLAGS: -L../rust_ffi/target/release -lfs_operations_core
        working-directory: file_manager
        run: go build -ldflags="-s -w" -o ../filemanager ./cmd/app

      - name: Build Go binary (macOS arm64)
        if: matrix.target == 'darwin-arm64'
        env:
          GOOS: darwin
          GOARCH: arm64
          CGO_ENABLED: 1
          CGO_LDFLAGS: -L../rust_ffi/target/aarch64-apple-darwin/release -lfs_operations_core
        working-directory: file_manager
        run: go build -ldflags="-s -w" -o ../filemanager ./cmd/app

      - name: Build Go binary (Windows amd64)
        if: matrix.target == 'windows-amd64'
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 1
          CGO_LDFLAGS: -L../rust_ffi/target/release -lfs_operations_core -lws2_32 -luserenv
        working-directory: file_manager
        run: go build -ldflags="-s -w" -o ../filemanager.exe ./cmd/app

      - name: Prepare distribution
        shell: bash
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p dist/${{ matrix.target }}
          
          # Copy Go binary
          if [ "${{ matrix.goos }}" = "windows" ]; then
            cp filemanager.exe dist/${{ matrix.target }}/
          else
            cp filemanager dist/${{ matrix.target }}/
          fi
          
          # Copy Rust core library (fs_operations_core)
          if [ "${{ matrix.goos }}" = "windows" ]; then
            find rust_ffi/target/release -name "fs_operations_core.dll" -exec cp {} dist/${{ matrix.target }}/ \; 2>/dev/null || echo "Windows DLL not found"
          elif [ "${{ matrix.target }}" = "linux-arm64" ]; then
            # ARM64 build uses different target directory
            find rust_ffi/target/aarch64-unknown-linux-gnu/release -name "libfs_operations_core.so" -exec cp {} dist/${{ matrix.target }}/ \; 2>/dev/null || true
          elif [ "${{ matrix.target }}" = "darwin-arm64" ]; then
            # macOS ARM64 uses different target directory
            find rust_ffi/target/aarch64-apple-darwin/release -name "libfs_operations_core.dylib" -exec cp {} dist/${{ matrix.target }}/ \; 2>/dev/null || true
          else
            if [ "${{ matrix.goos }}" = "darwin" ]; then
              find rust_ffi/target/release -name "libfs_operations_core.dylib" -exec cp {} dist/${{ matrix.target }}/ \; 2>/dev/null || \
              find rust_ffi/target/release -name "libfs_operations_core.so" -exec cp {} dist/${{ matrix.target }}/libfs_operations_core.dylib \; 2>/dev/null || true
            else
              find rust_ffi/target/release -name "libfs_operations_core.so" -exec cp {} dist/${{ matrix.target }}/ \; 2>/dev/null || true
            fi
          fi
          
          # Copy Rust CLI binary (fsops)
          if [ "${{ matrix.goos }}" = "windows" ]; then
            find rust_ffi/target/release -name "fsops.exe" -exec cp {} dist/${{ matrix.target }}/ \; 2>/dev/null || echo "fsops.exe not found"
          else
            find rust_ffi/target/release -name "fsops" -not -name "*.d" -type f -executable -exec cp {} dist/${{ matrix.target }}/ \; 2>/dev/null || echo "fsops binary not found"
          fi
          
          # Copy documentation
          cp file_manager/README.md dist/${{ matrix.target }}/README.md || true
          cp LICENSE dist/${{ matrix.target }}/ || true
          cp rust_ffi/README.md dist/${{ matrix.target }}/RUST_FFI_README.md || true
          
          # Create installer scripts
          if [ "${{ matrix.goos }}" = "windows" ]; then
            cat > dist/${{ matrix.target }}/install.bat << 'EOF'
          @echo off
          REM FileManager Installation Script
          echo Installing FileManager...
          set INSTALL_DIR=%ProgramFiles%\FileManager
          if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
          
          REM Copy Go binary
          copy /Y filemanager.exe "%INSTALL_DIR%\"
          
          REM Copy Rust core library
          copy /Y fs_operations_core.dll "%INSTALL_DIR%\" 2>nul
          
          REM Copy Rust CLI binary
          copy /Y fsops.exe "%INSTALL_DIR%\" 2>nul
          
          REM Add to PATH
          setx /M PATH "%PATH%;%INSTALL_DIR%"
          echo Installation complete!
          pause
          EOF
          else
            cat > dist/${{ matrix.target }}/install.sh << 'EOF'
          #!/bin/bash
          set -e
          echo "Installing FileManager..."
          
          # Detect OS
          OS=$(uname -s)
          
          # Install Go binary
          sudo cp filemanager /usr/local/bin/
          sudo chmod +x /usr/local/bin/filemanager
          
          # Install Rust core library
          if [ "$OS" = "Darwin" ]; then
            if [ -f libfs_operations_core.dylib ]; then
              sudo cp libfs_operations_core.dylib /usr/local/lib/
            elif [ -f libfs_operations_core.so ]; then
              sudo cp libfs_operations_core.so /usr/local/lib/libfs_operations_core.dylib
            fi
          else
            if [ -f libfs_operations_core.so ]; then
              sudo cp libfs_operations_core.so /usr/local/lib/
              sudo ldconfig
            fi
          fi
          
          # Install Rust CLI binary if available
          if [ -f fsops ]; then
            sudo cp fsops /usr/local/bin/
            sudo chmod +x /usr/local/bin/fsops
          fi
          
          echo "Installation complete!"
          EOF
            chmod +x dist/${{ matrix.target }}/install.sh
          fi

      - name: Create archive
        shell: bash
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          cd dist
          
          # Create archive with naming pattern: filemanager-{VERSION}-{TARGET}.{EXT}
          if [ "${{ matrix.goos }}" = "windows" ]; then
            7z a ../filemanager-${VERSION}-${{ matrix.target }}.zip ${{ matrix.target }}/
          else
            tar czf ../filemanager-${VERSION}-${{ matrix.target }}.tar.gz ${{ matrix.target }}/
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: filemanager-${{ matrix.target }}
          path: filemanager-*-${{ matrix.target }}.*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Move artifacts to root
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} release-files/ \;

      - name: Generate checksums
        run: |
          cd release-files
          sha256sum * > ../checksums.txt
          cd ..
          echo "=== Checksums ==="
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-files/*
            checksums.txt
          body: |
            ## FileManager ${{ github.ref_name }}
            
            ### üéâ What's New
            
            <!-- Add release notes here -->
            
            ### üì• Installation
            
            **Linux (amd64):**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/filemanager-${GITHUB_REF#refs/tags/v}-linux-amd64.tar.gz | tar xz
            cd linux-amd64
            sudo ./install.sh
            ```
            
            **Linux (ARM64):**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/filemanager-${GITHUB_REF#refs/tags/v}-linux-arm64.tar.gz | tar xz
            cd linux-arm64
            sudo ./install.sh
            ```
            
            **macOS (Apple Silicon):**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/filemanager-${GITHUB_REF#refs/tags/v}-darwin-arm64.tar.gz | tar xz
            cd darwin-arm64
            sudo ./install.sh
            ```
            
            **macOS (Intel):**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/filemanager-${GITHUB_REF#refs/tags/v}-darwin-amd64.tar.gz | tar xz
            cd darwin-amd64
            sudo ./install.sh
            ```
            
            **Windows:**
            Download the `.zip` file for your architecture and run `install.bat` as Administrator.
            
            ### üìã Checksums
            
            SHA256 checksums are included in `checksums.txt`
            
            ### üêõ Bug Reports
            
            Please report issues at: https://github.com/${{ github.repository }}/issues
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
